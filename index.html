<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fixeve Timer</title>
<style>
  body {
    background-color: #eef6ff;
    font-family: "Arial", sans-serif;
    text-align: center;
    padding: 30px;
    transition: background-color 0.1s;
  }
  h1 { margin-bottom: 10px; }
  #timer {
    font-size: 64px;
    margin: 20px 0;
  }
  #status, #total {
    font-size: 20px;
    margin: 10px 0;
  }
  button {
    font-size: 20px;
    margin: 10px;
    padding: 10px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .start { background-color: #4caf50; color: white; }
  .pause { background-color: #ff9800; color: white; }
  .stop { background-color: #f44336; color: white; }
  select {
    padding: 8px;
    font-size: 18px;
  }
  #home {
    display: block;
    margin-top: 30px;
    color: #007bff;
    text-decoration: none;
  }
</style>
</head>
<body>
  <h1>タイマー</h1>

  <label for="mode">モード選択：</label>
  <select id="mode">
    <option value="up">カウントアップ</option>
    <option value="pomodoro">25分勉強 / 5分休憩</option>
    <option value="focus50">50分勉強 / 10分休憩</option>
  </select>

  <div id="timer">00:00</div>
  <div id="status">停止中</div>
  <div id="total">今日の合計：0時間0分</div>

  <button class="start" id="startBtn">開始</button>
  <button class="pause" id="pauseBtn">中断</button>
  <button class="stop" id="stopBtn">終了</button>

  <a id="home" href="https://fixeve.github.io/fixeve-home/">ホームに戻る</a>

<script>
let timerDisplay = document.getElementById("timer");
let statusDisplay = document.getElementById("status");
let totalDisplay = document.getElementById("total");
let startBtn = document.getElementById("startBtn");
let pauseBtn = document.getElementById("pauseBtn");
let stopBtn = document.getElementById("stopBtn");
let modeSelect = document.getElementById("mode");

let timer = null;
let timeLeft = 0;
let isRunning = false;
let isStudy = true;
let setCount = 1;
let flashing = false;
let elapsedUp = 0; // カウントアップ用経過秒数

function todayKey() {
  const now = new Date();
  now.setHours(now.getHours() + 9);
  return now.toISOString().split("T")[0];
}

function checkDailyReset() {
  const savedDate = localStorage.getItem("fixeve_date");
  const today = todayKey();
  if (savedDate !== today) {
    localStorage.setItem("fixeve_date", today);
    localStorage.setItem("fixeve_studyTime", "0");
  }
}
checkDailyReset();

function updateTotalDisplay() {
  const sec = parseInt(localStorage.getItem("fixeve_studyTime") || "0");
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  totalDisplay.textContent = `今日の合計：${h}時間${m}分`;
}

function recordStudy(seconds) {
  if (seconds <= 0) return;
  let sec = parseInt(localStorage.getItem("fixeve_studyTime") || "0");
  localStorage.setItem("fixeve_studyTime", sec + seconds);
  updateTotalDisplay();
}

function updateDisplay() {
  const minutes = String(Math.floor(timeLeft / 60)).padStart(2, "0");
  const seconds = String(timeLeft % 60).padStart(2, "0");
  timerDisplay.textContent = `${minutes}:${seconds}`;
}

function getInitialTime() {
  if (modeSelect.value === "pomodoro") return 60;
  if (modeSelect.value === "focus50") return 3000;
  return 0;
}

// モード変更時に記録＆リセット
modeSelect.addEventListener("change", () => {
  if (isRunning) pauseTimer();
  if (modeSelect.value === "up" && elapsedUp > 0) {
    recordStudy(elapsedUp);
  } else if (isStudy && timeLeft > 0 && getInitialTime() > 0) {
    recordStudy(getInitialTime() - timeLeft);
  }
  stopTimer();
  elapsedUp = 0;
});

// --- 超チカチカ ---
function startFlashing() {
  flashing = true;
  let colors = ["#9f00ff", "#000000", "#baff00", "#000000"];
  let i = 0;
  let flashInterval = setInterval(() => {
    if (!flashing) {
      clearInterval(flashInterval);
      document.body.style.backgroundColor = "#eef6ff";
      return;
    }
    document.body.style.backgroundColor = colors[i % colors.length];
    i++;
  }, 150);
  document.body.addEventListener("click", nextAfterFlash, { once: true });
}

function nextAfterFlash() {
  flashing = false;
  isStudy = !isStudy;
  if (isStudy) {
    setCount++;
    const longBreak = (modeSelect.value === "pomodoro" ? 900 : 1800);
    const studyTime = (modeSelect.value === "pomodoro" ? 60 : 3000);
    timeLeft = (setCount % 5 === 0) ? longBreak : studyTime;
  } else {
    timeLeft = (modeSelect.value === "pomodoro" ? 300 : 600);
  }
  updateDisplay();
  startTimer();
}

function startTimer() {
  if (isRunning) return;
  isRunning = true;
  statusDisplay.textContent = isStudy ? "勉強中" : "休憩中";

  timer = setInterval(() => {
    if (modeSelect.value === "up") {
      elapsedUp++;
      timeLeft = elapsedUp;
    } else {
      timeLeft--;
      if (timeLeft < 0) {
        clearInterval(timer);
        isRunning = false;
        if (isStudy) recordStudy(modeSelect.value === "pomodoro" ? 60 : 3000);
        startFlashing();
        return;
      }
    }
    updateDisplay();
  }, 1000);
}

function pauseTimer() {
  if (!isRunning) return;
  clearInterval(timer);
  isRunning = false;
  statusDisplay.textContent = "一時停止中";
}

function stopTimer() {
  clearInterval(timer);
  isRunning = false;
  isStudy = true;
  setCount = 1;
  timeLeft = 0;
  updateDisplay();
  statusDisplay.textContent = "停止中";
}

startBtn.onclick = () => {
  if (modeSelect.value !== "up" && timeLeft === 0) timeLeft = getInitialTime();
  startTimer();
};
pauseBtn.onclick = pauseTimer;
stopBtn.onclick = () => {
  if (modeSelect.value === "up") {
    recordStudy(elapsedUp);
  } else if (isStudy && timeLeft > 0 && getInitialTime() > 0) {
    recordStudy(getInitialTime() - timeLeft);
  }
  stopTimer();
  elapsedUp = 0;
};

updateDisplay();
updateTotalDisplay();
</script>
</body>
</html>
